\ProvidesPackage{umlmultidocument}

\usepackage{pgf,tikz}
\usepackage{pgfarrows,pgfnodes,pgfautomata,pgfheaps}
\usepackage{pgfbaseshapes}
\usetikzlibrary{calc,arrows}

\makeatletter

\pgfdeclareshape{umlmultidocument} {
    \inheritsavedanchors[from=rectangle]
    \inheritanchorborder[from=rectangle]
    \inheritanchor[from=rectangle]{center}
    \inheritanchor[from=rectangle]{north}
    \inheritanchor[from=rectangle]{north east}
    \inheritanchor[from=rectangle]{north west}
    \inheritanchor[from=rectangle]{south}
    \inheritanchor[from=rectangle]{south east}
    \inheritanchor[from=rectangle]{south west}
    \inheritanchor[from=rectangle]{west}
    \inheritanchor[from=rectangle]{east}
		
    \beforebackgroundpath {
				\tikz@mode% installs the mode settings
				
				\newdimen\zz
				\pgfmathsetlength\zz{\pgfkeysvalueof{/pgf/minimum height}}%
				\zz = 0.2\zz
		
        \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
        \pgf@xc=\pgf@xb \advance\pgf@xc by -\zz
        \pgf@yc=\pgf@yb \advance\pgf@yc by -\zz
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \pgfpathclose
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
				\pgfpathclose
				
				\iftikz@mode@fill
					\pgfsetfillcolor{\tikz@fillcolor}
				\else
					\pgfsetfillcolor{lightgray}
				\fi
				
        \iftikz@mode@draw% fill and stroke if draw is choosen
            \pgfusepath{fill, stroke}
        \else% fill only if draw is not choosen
            \pgfusepath{fill}
        \fi
				
				\southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
				\advance\pgf@xa by-3pt
				\advance\pgf@ya by-3pt
				\advance\pgf@xb by-3pt
				\advance\pgf@yb by-3pt
        \pgf@xc=\pgf@xb \advance\pgf@xc by -\zz
        \pgf@yc=\pgf@yb \advance\pgf@yc by -\zz
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \pgfpathclose
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
				\pgfpathclose
				
				\iftikz@mode@fill
					\pgfsetfillcolor{\tikz@fillcolor}
				\else
					\pgfsetfillcolor{lightgray}
				\fi
				
        \iftikz@mode@draw% fill and stroke if draw is choosen
            \pgfusepath{fill, stroke}
        \else% fill only if draw is not choosen
            \pgfusepath{fill}
        \fi
				
				\southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
				\advance\pgf@xa by-6pt
				\advance\pgf@ya by-6pt
				\advance\pgf@xb by-6pt
				\advance\pgf@yb by-6pt
        \pgf@xc=\pgf@xb \advance\pgf@xc by -\zz
        \pgf@yc=\pgf@yb \advance\pgf@yc by -\zz
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
        \pgfpathclose
        \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yc}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
				\pgfpathclose
				
				\iftikz@mode@fill
					\pgfsetfillcolor{\tikz@fillcolor}
				\else
					\pgfsetfillcolor{lightgray}
				\fi
				
        \iftikz@mode@draw% fill and stroke if draw is choosen
            \pgfusepath{fill, stroke}
        \else% fill only if draw is not choosen
            \pgfusepath{fill}
        \fi
				
		}
		
		\anchor{south}{%
			\pgf@process{\northeast}%
			\pgf@xa=1.5\pgf@x%
			\pgf@process{\southwest}%
			\pgf@x=.5\pgf@x%
			\advance\pgf@x by \pgf@xa%
			\pgf@x=.25\pgf@x%
			\advance\pgf@y by -6pt
		}%
		
		\anchor{west}{%
			\pgf@process{\northeast}%
			\pgf@ya=.4\pgf@y%
			\pgf@process{\southwest}%
			\pgf@y=.5\pgf@y%
			\advance\pgf@y by \pgf@ya%
			\pgf@y=.5\pgf@y%
			\advance\pgf@x by -6pt
		}%
		
		%\anchor{height}{%
		%	\pgf@process{south}%
		%	\pgf@yc=\pgf@y
		%	\pgf@process{north}%
		%	\advance\pgf@y by -\pgf@yc
		%	\pgf@x=\z@
		%	\edef\pgf@temp{\csname pgf@sh@nt@\pgfreferencednodename\endcsname}%
		%	\expandafter\@shiftback\pgf@temp
		%}
		%\anchor{size}{%
		%	\pgf@process{west}%
		%	\pgf@xc=\pgf@x
		%	\pgf@yc=\pgf@y
		%	\pgf@process{east}%
		%	\advance\pgf@x by -\pgf@xc
		%	\advance\pgf@y by -\pgf@yc
		%	\edef\pgf@temp{\csname pgf@sh@nt@\pgfreferencednodename\endcsname}%
		%	\expandafter\@shiftback\pgf@temp
		%}
		
		\nodeparts{text}%
		\savedanchor{\mymacroname}{% manual 1035
			\pgf@y=.15\ht\pgfnodeparttextbox % height of the box
			\pgf@x=.15\wd\pgfnodeparttextbox % width of the box
			\setlength{\pgf@xa}{.15\pgfshapeminwidth}%
			\ifdim\pgf@x<.15\pgf@xa
				\pgf@x=\pgf@xa
			\fi
			\setlength{\pgf@ya}{\pgfshapeminheight}%
			\ifdim\pgf@y<\pgf@ya
				\pgf@y=.1\pgf@ya
			\fi
		}%
		\anchor{text}{%
			\mymacroname
			\pgf@x=-\pgf@x
			\pgf@y=-\pgf@y
		}%
}

% Key to add font macros to the current font
\tikzset{add font/.code={\expandafter\def\expandafter\tikz@textfont\expandafter{\tikz@textfont#1}}} 

% Define default style for this node
\tikzset{umlmultidocument/port labels/.style={font=\sffamily}}
\tikzset{every umlmultidocument node/.style={draw, inner sep=2mm, outer sep=0pt,font=\scriptsize}}

\makeatother